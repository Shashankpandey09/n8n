name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    environment: Env  
    env:
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      DATABASE_URL: ${{ vars.DATABASE_URL }}

    steps:
     
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Docker Compose availability
        run: docker compose version

      - name: Create .env for primary_backend
        run: |
          echo "DATABASE_URL=${DATABASE_URL}" > primary_backend/.env
          echo "ENCRYPTION_KEY=${ENCRYPTION_KEY}" >> primary_backend/.env
          echo "SECRET_KEY=${SECRET_KEY}" >> primary_backend/.env

      - name: Install dependencies for primary_backend
        working-directory: ./primary_backend
        run: npm ci

      - name: Create .env for Executor
        run: |
          echo "DATABASE_URL=${DATABASE_URL}" > Executor/.env
          echo "ENCRYPTION_KEY=${ENCRYPTION_KEY}" >> Executor/.env
          echo "SECRET_KEY=${SECRET_KEY}" >> Executor/.env

      - name: Install dependencies for Executor
        working-directory: ./Executor
        run: npm ci
     
      - name: Debug DATABASE_URL + .env
        run: |
          echo "DATABASE_URL length: ${#DATABASE_URL}"
          if [ -f primary_backend/.env ]; then
            echo "primary_backend/.env:"
            sed 's/=.*/=***MASKED***/' primary_backend/.env || true
          else
            echo "‚ùå primary_backend/.env does not exist yet"
          fi
 
      - name: Run tests
        run: npm run test
